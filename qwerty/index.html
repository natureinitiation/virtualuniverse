<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json" />
    <title>QWERTY –≤ –Ø–®–ï–†–¢–´</title>
    <style>
        /* --- –ù–û–ß–ù–ê–Ø –¢–ï–ú–ê --- */
        body {
            font-family: Arial, sans-serif;
            margin-top: 30px;
            margin-bottom: 30px;
            background-color: #121212; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            color: #e0e0e0; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #1e1e1e; /* –ß—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ, —á–µ–º —Ñ–æ–Ω —Ç–µ–ª–∞ */
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        h1 {
            color: #bb86fc; /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
            border-bottom: 2px solid #bb86fc;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        textarea {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            resize: vertical;
            background-color: #2c2c2c; /* –§–æ–Ω –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π */
            color: #e0e0e0; /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª—è—Ö */
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
        .copy-button {
            padding: 10px 15px;
            font-size: 16px;
            background-color: #03dac6; /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ */
            color: #121212;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: -10px; /* –°–º–µ—Å—Ç–∏—Ç—å –±–ª–∏–∂–µ –∫ –ø–æ–ª—é –≤—ã–≤–æ–¥–∞ */
            display: block;
            width: 100%;
        }
        .copy-button:hover {
            background-color: #039c8c;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>QWERTY –≤ –Ø–®–ï–†–¢–´</h1>
    <p>–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É—è –≤–∞—à—É –ª–∞—Ç–∏–Ω—Å–∫—É—é —Ä–∞—Å–∫–ª–∞–¥–∫—É, –∏ –æ–Ω –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ –∫–∏—Ä–∏–ª–ª–∏—Ü—É.</p>

    <label for="latinInput">–õ–∞—Ç–∏–Ω—Å–∫–∏–π –í–≤–æ–¥:</label>
    <textarea id="latinInput" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–∫—Å—Ç —Å—é–¥–∞..."></textarea>

    <label for="cyrillicOutput">–ö–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–π –í—ã–≤–æ–¥:</label>
    <textarea id="cyrillicOutput" rows="6" readonly placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
    
    <button id="copyButton" class="copy-button">
        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ö–∏—Ä–∏–ª–ª–∏—Ü—É
    </button>
</div>

<script>
    // 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –°–ª–æ–≤–∞—Ä—è –ü—Ä–∞–≤–∏–ª
    
    // –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (—Å—Ç—Ä–æ—á–Ω—ã–µ)
    const MAPPING_LOWERCASE = new Map([
        ['eee', '—ë'], ['uu', '—é'], ['zz', '–∂'], ['ww', '—â'], ['ee', '—ç'], ["''", '—ä'],
        ['a', '–∞'], ['b', '–±'], ['v', '–≤'], ['g', '–≥'], ['d', '–¥'], ['e', '–µ'],
        ['z', '–∑'], ['i', '–∏'], ['j', '–π'], ['k', '–∫'], ['l', '–ª'], ['m', '–º'],
        ['n', '–Ω'], ['o', '–æ'], ['p', '–ø'], ['r', '—Ä'], ['s', '—Å'], ['t', '—Ç'],
        ['u', '—É'], ['f', '—Ñ'], ['x', '—Ö'], ['c', '—Ü'], ['h', '—á'], ['w', '—à'],
        ['y', '—ã'], ['q', '—è'], ["'", '—å'], 
        [' ', ' '], ['.', '.'], [',', ','], ['!', '!'], ['?', '?'],
        ['0', '0'], ['1', '1'], ['2', '2'], ['3', '3'], ['4', '4'],
        ['5', '5'], ['6', '6'], ['7', '7'], ['8', '8'], ['9', '9'],
    ]);
    
    const MAPPING = new Map();
    for (const [lat, cyr] of MAPPING_LOWERCASE) MAPPING.set(lat, cyr);
    for (const [lat, cyr] of MAPPING_LOWERCASE) {
        if (lat.length > 3 || !lat.match(/[a-z]/i)) continue;
        MAPPING.set(lat.toUpperCase(), cyr.toUpperCase());
    }
    const sorted_keys = Array.from(MAPPING.keys()).sort((a, b) => b.length - a.length);


    // 2. –§—É–Ω–∫—Ü–∏—è –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏ (–ù–∞–¥–µ–∂–Ω—ã–π –º–µ—Ç–æ–¥ —Å —Å–∞–º—ã–º –¥–ª–∏–Ω–Ω—ã–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º)
    function transcodeToCyrillic(lat_text) {
        if (!lat_text) return '';

        let output = [];
        let i = 0;
        const text = lat_text;
        const len = text.length;

        while (i < len) {
            let foundMatch = false;
            for (const lat_key of sorted_keys) {
                const key_len = lat_key.length;
                if (text.substring(i, i + key_len) === lat_key) {
                    output.push(MAPPING.get(lat_key));
                    i += key_len;
                    foundMatch = true;
                    break;
                }
            }
            if (!foundMatch) {
                output.push(text[i]);
                i++;
            }
        }
        return output.join('');
    }


    // 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –í–≤–æ–¥–æ–º (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ü–∞—É–∑–µ)
    const latinInput = document.getElementById('latinInput');
    const cyrillicOutput = document.getElementById('cyrillicOutput');
    const copyButton = document.getElementById('copyButton'); 

    let inputTimeout = null; 
    const DELAY_MS = 300; 
    let finalizedCyrillicText = ""; 

    // –°–∏–º–≤–æ–ª—ã, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ –º–Ω–æ–≥–æ—Å–∏–º–≤–æ–ª—å–Ω–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, e, u, z, w, ')
    const MULTI_CHAR_FINALIZE_WHITELIST = new Set(['e', 'u', 'z', 'w', "'"]); 

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥ —Ç–æ–ª—å–∫–æ –∏–∑ –æ–¥–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è —Å–∏–º–≤–æ–ª–∞
     */
    function isSingleRepeatingChar(text) {
        if (text.length === 0) return false;
        
        const firstChar = text[0].toLowerCase();
        const isRepeating = /^(.)\1*$/.test(text.toLowerCase());
        const isCombinationStarter = MULTI_CHAR_FINALIZE_WHITELIST.has(firstChar);

        // –†–∞–∑—Ä–µ—à–∞–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞ (eee, uu, zz)
        if (isRepeating && isCombinationStarter) {
            return true;
        }
        
        // –†–∞–∑—Ä–µ—à–∞–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–¥–∏–Ω–æ—á–Ω—ã–π —Å–∏–º–≤–æ–ª, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –Ω–∞—á–∞–ª–æ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ (t, r, k)
        if (text.length === 1 && !isCombinationStarter) {
            return true;
        }

        return false;
    }


    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–≤–æ–¥–∞
    function finalizeInput() {
        const currentActiveInput = latinInput.value;
        
        if (currentActiveInput.length === 0) return;

        // --- –§–ò–õ–¨–¢–†: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–¥–∏–Ω–æ—á–Ω—ã–π –∏–ª–∏ –º–Ω–æ–≥–æ—Å–∏–º–≤–æ–ª—å–Ω—ã–π –≤–≤–æ–¥ ---
        if (!isSingleRepeatingChar(currentActiveInput)) {
            // –ï—Å–ª–∏ —ç—Ç–æ —Å–ª–æ–∂–Ω–æ–µ —Å–ª–æ–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'test'), –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–∞—É–∑—É.
            return; 
        }

        // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –ø—Ä–æ–π–¥–µ–Ω (—ç—Ç–æ 'eee' –∏–ª–∏ 't'), –≤—ã–ø–æ–ª–Ω—è–µ–º —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—é:
        const decodedChunk = transcodeToCyrillic(currentActiveInput);
        
        finalizedCyrillicText += decodedChunk;
        cyrillicOutput.value = finalizedCyrillicText;
        
        // –û—á–∏—â–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –Ω–æ–≤–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ (—ç—Ç–æ—Ç —à–∞–≥ —Ä–µ–∞–ª–∏–∑—É–µ—Ç "—Å–±—Ä–æ—Å")
        latinInput.value = '';
        
        // --- –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–û–ó–í–†–ê–©–ê–ï–ú –§–û–ö–£–° ---
        // –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —á—Ç–æ–±—ã –ª–æ–≥–∏–∫–∞ –≤–≤–æ–¥–∞ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–ª–∞—Å—å
        latinInput.focus();
    }


    // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –ø–∞—É–∑–µ
    latinInput.addEventListener('input', function() {
        // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ –Ω–æ–≤–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
        if (inputTimeout) {
            clearTimeout(inputTimeout);
        }
        
        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥ + —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
        const currentDecodedPreview = transcodeToCyrillic(latinInput.value);
        cyrillicOutput.value = finalizedCyrillicText + currentDecodedPreview;

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
        inputTimeout = setTimeout(finalizeInput, DELAY_MS);
    });


    // 4. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ö–Ω–æ–ø–∫–∏ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    copyButton.addEventListener('click', function() {
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥ –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        const currentActiveInput = latinInput.value;
        if (currentActiveInput.length > 0) {
            const decodedChunk = transcodeToCyrillic(currentActiveInput);
            finalizedCyrillicText += decodedChunk;
            latinInput.value = '';
        }
        
        // –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        const textToCopy = finalizedCyrillicText;
        
        if (navigator.clipboard && textToCopy) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                copyButton.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    copyButton.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ö–∏—Ä–∏–ª–ª–∏—Ü—É';
                }, 1500); 
            }).catch(err => {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
            });
        } else {
            alert('–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.');
        }
        latinInput.focus();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    latinInput.focus(); 
</script>

</body>
</html>
