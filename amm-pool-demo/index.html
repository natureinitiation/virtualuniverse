<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>XRP / USDC AMM ¬∑ XRPL</title>
<script src="https://unpkg.com/xrpl@2.14.0/build/xrpl-latest.js"></script>

<style>
  /* CSS STYLES */
  body {margin:0;font-family:system-ui;background:#0b0e17;color:#e0e0ff}
  
  /* Main container, centered on the page */
  .c {
    max-width:560px;
    margin:40px auto;
    background:#11131f;
    border-radius:20px;
    overflow:hidden;
    box-shadow:0 20px 60px #00000099;
    text-align: center; /* Center main content blocks */
  }

  header {background:linear-gradient(135deg,#0066ff,#00d4ff);padding:30px;text-align:center;color:#fff}
  .n {font-size:28px;font-weight:800;margin:0}
  .t {font-size:48px;font-weight:900;margin:15px 0 5px}
  
  main {padding:30px}
  
  .tks {display:flex;justify-content:space-around;margin:30px 0}
  .tk {text-align:center}
  .a {font-size:32px;font-weight:bold}
  .l {font-size:14px;opacity:.8;margin-top:5px}
  
  .s {display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:30px}
  .b {background:#1a1d2e;padding:20px;border-radius:16px;text-align:center}
  .bl {font-size:14px;opacity:.7}
  .bv {font-size:26px;font-weight:bold;margin-top:8px;color:#00ff9d}
  
  .btn {width:100%;padding:18px;margin-top:30px;background:#0066ff;color:#fff;font-size:20px;font-weight:bold;border:none;border-radius:16px;cursor:pointer;transition:.2s}
  .btn:hover {background:#0055dd}
  
  /* Centering content within info and calc blocks */
  .info, .calc {
    margin:40px auto 30px; 
    padding:25px; 
    border-radius:16px; 
    background:#1a1d2e; 
    line-height:1.6;
    opacity:.9;
    text-align: center; /* CENTER CONTENT */
  }

  /* Specific style for description paragraphs */
  .info p {
      text-align: center; /* ALIGN TEXT CENTERED */
      display: block;
      padding: 0;
      /* Vertical margin setup based on your request */
      margin-top: 32px; 
      margin-bottom: 24px; 
  }
  
  /* Reset margin for the first paragraph in the info block */
  .info p:first-of-type {
      margin-top: 0;
  }
  
  /* Reset margin for the last paragraph in the info block */
  .info p:last-of-type {
      margin-bottom: 0;
  }

  /* FIXED INPUT WIDTH and center text */
  input {
    width: 90%; 
    max-width: 90%;
    padding:14px;
    margin:8px 0;
    border-radius:10px;
    border:none;
    background:#252940;
    color:#fff;
    font-size:16px;
    box-sizing: border-box;
    text-align: center; /* CENTER TEXT IN INPUT FIELD */
  }

  .res {margin-top:20px;padding:18px;background:#0004;border-radius:12px;font-size:18px;font-weight:bold;text-align:center}
  .warn {color: #ffeb3b; font-size: 14px; margin-top: 15px;}
  .swap-block {margin-top: 25px; padding-top: 25px; border-top: 1px solid #333;}

  /* ---------------------- FOOTER STYLES ---------------------- */
  footer {
    padding: 20px 0;
    margin-top: 30px;
    font-size: 14px;
    opacity: 0.7;
    text-align: center; 
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è (–∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏) */
  .footer-item {
    display: block; 
    margin-bottom: 5px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏ */
    line-height: 1;
  }
  
  footer a {
    color: #00aaff;
    text-decoration: none;
    font-weight: bold;
    display: inline-block; /* –î–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ –≤–Ω—É—Ç—Ä–∏ */
  }
  .powered-by-logo {
    display: inline-block; 
    width: 30px; 
    height: 30px;
    /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º */
    background-image: url('https://natureinitiation.github.io/virtualuniverse/amm-pool-demo/logo.png');
    background-size: contain;
    background-repeat: no-repeat;
    vertical-align: middle;
  }
  /* ------------------------------------------------------------- */
</style>
</head>
<body>

<div class="c">
  <header>
    <h1 class="n">XRP / USDC</h1>
    <div class="t">$10.60M</div>
    <small>Total in pool ¬∑ AMM #42 ¬∑ XRPL Mainnet</small>
  </header>

  <main>
    <div class="tks">
      <div class="tk"><div class="a">2.41M</div><div class="l">XRP ($2.20)</div></div>
      <div class="tk"><div class="a">5.30M</div><div class="l">USDC</div></div>
    </div>

    <div class="s">
      <div class="b"><div class="bl">24h Volume</div><div class="bv">$2.85M</div></div>
      <div class="b"><div class="bl">24h Fees</div><div class="bv">$8.5k</div></div>
      <div class="b"><div class="bv" style="color:#ffeb3b">0.30%</div><div class="bl">Fee tier</div></div>
      <div class="b"><div class="bv" style="color:#ff5722">12.8%</div><div class="bl">APR</div></div>
    </div>

    <button class="btn" id="connect-wallet-btn" onclick="connectWallet()">üîë Connect Xaman Wallet</button>
    <div id="connection-status" class="warn" style="display:none;"></div>


    <div class="calc swap-block">
      <h3 style="margin:0 0 15px 0;color:#0cf">üöÄ Swap: XRP ‚Üí USDC</h3>
      
      <div style="font-size:14px; margin-bottom: 5px; opacity:.8;">You pay (XRP):</div>
      <input type="number" id="swap-xrp-in" placeholder="Amount of XRP" value="10" step="0.01">

      <div style="font-size:14px; margin: 15px 0 5px 0; opacity:.8;">You receive approx. (USDC):</div>
      <input type="text" id="swap-usdc-out" placeholder="Estimated USDC" disabled>

      <div class="res" id="slippage-info-xrp">
        <span style="color:#0cf">Price: 1 XRP ‚âà 2.20 USDC</span> | Slippage: <span style="color:#ffeb3b">~0.0%</span>
      </div>

      <button class="btn" id="swap-btn-xrp" onclick="sendAmmSwap('XRP_TO_USDC')" disabled>Swap XRP (Sign in Xaman)</button>
    </div>
    
    <div class="calc swap-block">
      <h3 style="margin:0 0 15px 0;color:#0cf">üöÄ Swap: USDC ‚Üí XRP</h3>
      
      <div style="font-size:14px; margin-bottom: 5px; opacity:.8;">You pay (USDC):</div>
      <input type="number" id="swap-usdc-in" placeholder="Amount of USDC" value="22" step="0.01">

      <div style="font-size:14px; margin: 15px 0 5px 0; opacity:.8;">You receive approx. (XRP):</div>
      <input type="text" id="swap-xrp-out" placeholder="Estimated XRP" disabled>

      <div class="res" id="slippage-info-usdc">
        <span style="color:#0cf">Price: 1 USDC ‚âà 0.45 XRP</span> | Slippage: <span style="color:#ffeb3b">~0.0%</span>
      </div>

      <button class="btn" id="swap-btn-usdc" onclick="sendAmmSwap('USDC_TO_XRP')" disabled>Swap USDC (Sign in Xaman)</button>
    </div>
    

    <button class="btn" style="background:#0066ff; margin-top: 30px;" onclick="alert('Coming soon!\n\nLiquidity adding requires an AMMDeposit transaction.')">+ Add Liquidity</button>
    <button class="btn" style="background:#333;margin-top:12px" onclick="alert('Claiming fees requires an AMMVote or AMMWithdraw transaction.')">Claim Fees</button>

    <div class="info">
      <p><b>What is this?</b><br>
      Native Automated Market Maker (AMM) pool directly on the XRP Ledger.</p>
      
      <p><b>How to swap:</b> Connect any XRPL wallet &rarr; choose amount &rarr; swap instantly. No order books, no waiting.</p>
      
      <p><b>Fees:</b> 0.30% trading fee goes 100% to liquidity providers. XRPL transaction fee &asymp; $0.0002.</p>
      
      <p><b>Earn passive income:</b> Deposit both tokens &rarr; receive LP tokens &rarr; earn part of every trade + voting rights on fee changes.</p>
    </div>
    <div class="calc">
      <h3 style="margin:0 0 15px 0;color:#0cf">Detailed Earnings Calculator</h3>
      <input type="number" id="volume" placeholder="Daily trading volume ($)" value="2850000">
      <input type="number" id="fee" placeholder="Pool fee (%)" value="0.3" step="0.01">
      <input type="number" id="share" placeholder="Your share of the pool (%)" value="1" step="0.01">

      <div class="res" id="result"></div>
    </div>
    
    <div class="info" style="margin-top: 0;">
      <p class="address"><b>Your Address:</b> <span id="sender-address">None</span> (Used to send the transaction)</p>
    </div>
  </main>
  
  <footer>
    <div class="footer-item">Powered by</div>
    
    <div class="footer-item">
        <a href="https://t.me/MemeCiti" target="_blank">
            <span class="powered-by-logo"></span>
        </a>
    </div>
    
    <div class="footer-item">
        <a href="https://t.me/MemeCiti" target="_blank">
            MMC
        </a>
    </div>
  </footer>
  </div>

<script>
// --- XRPL ADDRESSES AND SETTINGS ---
let connectedWalletAddress = null;

// Mock Pool Data (Used for price/slippage calculation)
const POOL_BALANCE_XRP = 2410000;
const POOL_BALANCE_USDC = 5300000; 

// Token Parameters
const AMM_POOL_XRP_CURRENCY = 'XRP';
const USDC_ISSUER = 'rhub8tfykuBqNYs4pDRzKswG3N2S5h39zK'; // Issuer Address for USDC
const AMM_POOL_USDC_CURRENCY = 'USDC';
const DEMO_ADDRESS = 'rEXAMPLEd5d...YourWalletAddress'; // Demo Connection Address

// --- XAMAN API SETTINGS (FOR REAL OPERATION - REPLACE THESE!) ---
// NOTE: For security, a real application must proxy Xaman API calls through a secure backend.
const XAMAN_PAYLOAD_ENDPOINT = 'YOUR_XAMAN_PAYLOAD_ENDPOINT'; 
const XAMAN_API_KEY = 'YOUR_API_KEY'; 
const XAMAN_API_SECRET = 'YOUR_API_SECRET'; 


// --- DOM ELEMENTS ---
const connectBtn = document.getElementById('connect-wallet-btn');
const swapBtnXRP = document.getElementById('swap-btn-xrp');
const swapBtnUSDC = document.getElementById('swap-btn-usdc');
const senderAddressDisplay = document.getElementById('sender-address'); 
const connStatus = document.getElementById('connection-status');

// Elements for XRP -> USDC
const swapXrpIn = document.getElementById('swap-xrp-in');
const swapUsdcOut = document.getElementById('swap-usdc-out');
const slippageInfoXRP = document.getElementById('slippage-info-xrp');

// Elements for USDC -> XRP
const swapUsdcIn = document.getElementById('swap-usdc-in');
const swapXrpOut = document.getElementById('swap-xrp-out');
const slippageInfoUSDC = document.getElementById('slippage-info-usdc');


// --- 1. PRICE AND SLIPPAGE CALCULATION LOGIC ---

/**
 * Calculates price and slippage using the Constant Product Formula (X*Y=K).
 */
function getPriceAndSlippage(amountIn, direction) {
    let X, Y, tokenInName, tokenOutName;

    if (direction === 'XRP_TO_USDC') {
        X = POOL_BALANCE_XRP;
        Y = POOL_BALANCE_USDC;
        tokenInName = 'XRP';
        tokenOutName = 'USDC';
    } else {
        X = POOL_BALANCE_USDC;
        Y = POOL_BALANCE_XRP;
        tokenInName = 'USDC';
        tokenOutName = 'XRP';
    }
    
    const initialPrice = Y / X; 
    
    // Calculate new balance
    const newX = X + amountIn;
    const newY = (X * Y) / newX;
    
    const amountOut = Y - newY;
    const finalPrice = amountOut / amountIn;
    
    const priceChange = ((initialPrice - finalPrice) / initialPrice) * 100;

    return {
        initialPrice,
        amountOut,
        slippagePercent: priceChange.toFixed(3),
        tokenInName,
        tokenOutName
    };
}

function updateSwapEstimate(direction) {
    const inputField = (direction === 'XRP_TO_USDC') ? swapXrpIn : swapUsdcIn;
    const outputField = (direction === 'XRP_TO_USDC') ? swapUsdcOut : swapXrpOut;
    const infoDisplay = (direction === 'XRP_TO_USDC') ? slippageInfoXRP : slippageInfoUSDC;

    const inputAmount = parseFloat(inputField.value) || 0;
    
    if (inputAmount <= 0) {
        outputField.value = '0.00';
        infoDisplay.innerHTML = `<span style="color:#0cf">Enter Amount</span>`;
        return;
    }

    const { initialPrice, amountOut, slippagePercent, tokenInName, tokenOutName } = getPriceAndSlippage(inputAmount, direction);
    
    outputField.value = amountOut.toFixed(4);
    
    let slippageColor = '#00ff9d';
    if (slippagePercent > 0.5) slippageColor = '#ffeb3b';
    if (slippagePercent > 1) slippageColor = '#ff5722';

    infoDisplay.innerHTML = `
        <span style="color:#0cf">Price: 1 ${tokenInName} &asymp; ${initialPrice.toFixed(4)} ${tokenOutName}</span> | 
        Slippage: <span style="color:${slippageColor}">&asymp;${slippagePercent}%</span>
    `;
}

// Wrapper functions for input event listeners
function updateXRPToUSDC() { updateSwapEstimate('XRP_TO_USDC'); }
function updateUSDCToXRP() { updateSwapEstimate('USDC_TO_XRP'); }


// --- 2. XAMAN WALLET CONNECTION LOGIC (MOCK) ---

function connectWallet() {
    // In a real application, you would initialize the Xaman SDK here 
    // and wait for the user to scan the QR code to resolve the address.
    
    // MOCK CONNECTION:
    connectedWalletAddress = DEMO_ADDRESS;
    senderAddressDisplay.textContent = DEMO_ADDRESS;
    
    connectBtn.textContent = '‚úÖ Connected: ' + DEMO_ADDRESS.substring(0, 8) + '...';
    connectBtn.disabled = true;
    swapBtnXRP.disabled = false;
    swapBtnUSDC.disabled = false;
    
    // Set up input listeners
    swapXrpIn.addEventListener('input', updateXRPToUSDC);
    swapUsdcIn.addEventListener('input', updateUSDCToXRP);
    
    updateXRPToUSDC(); 
    updateUSDCToXRP(); 

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Ä–∞–±–æ—á–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    connStatus.style.display = 'block';
    connStatus.style.color = '#00ff9d';
    connStatus.textContent = 'Wallet successfully connected (Mock). You can send transactions.';
}


// --- 3. AMM SWAP TRANSACTION LOGIC ---

async function sendAmmSwap(direction) {
    if (!connectedWalletAddress) {
        connStatus.style.display = 'block';
        connStatus.style.color = '#ff5722';
        connStatus.textContent = "Error: Please connect wallet first.";
        return;
    }
    
    let amountIn, amountOut;
    
    if (direction === 'XRP_TO_USDC') {
        amountIn = parseFloat(swapXrpIn.value);
        amountOut = parseFloat(swapUsdcOut.value);
    } else { // USDC_TO_XRP
        amountIn = parseFloat(swapUsdcIn.value);
        amountOut = parseFloat(swapXrpOut.value);
    }

    if (amountIn <= 0 || amountOut <= 0) {
        connStatus.style.display = 'block';
        connStatus.style.color = '#ff5722';
        connStatus.textContent = "Error: Please enter a valid amount.";
        return;
    }
    
    // Set max slippage tolerance to 0.5% (adjust as needed)
    const slippageTolerance = 0.005;
    const minAmountOut = amountOut * (1 - slippageTolerance); 

    let sendMaxAmount, amountReceived, memoText;

    if (direction === 'XRP_TO_USDC') {
        // XRP -> USDC SWAP
        sendMaxAmount = xrpl.xrpToDrops(amountIn); // Amount Sent (XRP, in drops)
        amountReceived = { 
            currency: AMM_POOL_USDC_CURRENCY,
            value: minAmountOut.toFixed(6), // Minimum Amount Received (USDC, issued)
            issuer: USDC_ISSUER
        }; 
        memoText = `XRP to USDC Swap via AMM`;
    } else {
        // USDC -> XRP SWAP
        sendMaxAmount = { 
            currency: AMM_POOL_USDC_CURRENCY,
            value: amountIn.toFixed(6), // Amount Sent (USDC, issued)
            issuer: USDC_ISSUER
        }; 
        amountReceived = xrpl.xrpToDrops(minAmountOut.toFixed(6)); // Minimum Amount Received (XRP, in drops)
        memoText = `USDC to XRP Swap via AMM`;
    }

    // A. Form the "Payment" transaction
    // The transaction uses the destination address as the sender's address. 
    // This allows the XRPL's pathfinding mechanism to route the swap through the best AMM/DEX path.
    const transaction = {
        TransactionType: "Payment",
        Account: connectedWalletAddress,
        Destination: connectedWalletAddress,
        
        Amount: amountReceived, // This is the MINIMUM amount the sender is willing to receive
        SendMax: sendMaxAmount, // This is the MAX amount the sender is willing to pay
        
        Flags: xrpl.txFlags.Payment.TF_PARTIAL_PAYMENT, // ESSENTIAL for pathfinding/AMM swap
        
        Memos: [{
            Memo: {
                MemoData: xrpl.convertStringToHex(memoText)
            }
        }]
    };
    
    // B. Create Xaman Payload Request
    const payloadRequest = {
        txjson: transaction,
        options: { expire: 5, submit: true },
        custom_meta: {
            instruction: `${memoText} (Min Recv: ${minAmountOut.toFixed(4)})`
        }
    };
    
    // C. Send Request to Xaman (MOCK implementation)
    connStatus.style.color = '#ffeb3b';
    connStatus.textContent = `Sending Xaman request for ${direction}... Check console for details.`;
    
    try {
        // !!! START: YOUR REAL XAMAN FETCH CODE GOES HERE !!!
        /* const response = await fetch(XAMAN_PAYLOAD_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': XAMAN_API_KEY,
                'X-API-Secret': XAMAN_API_SECRET
            },
            body: JSON.stringify(payloadRequest)
        });
        const mockResponse = await response.json(); 
        */
        // !!! END: YOUR REAL XAMAN FETCH CODE GOES HERE !!!


        // MOCK Response for demo:
        const mockResponse = {
            uuid: 'd3m0-uui-d1234',
            next: { always: 'https://xumm.app/sign/d3m0-uui-d1234' }
        };

        console.log("--- GENERATED TRANSACTION (PAYMENT) ---", transaction);
        
        connStatus.style.color = '#00ff9d';
        connStatus.innerHTML = `Request sent (UUID: ${mockResponse.uuid}). <a href="${mockResponse.next.always}" target="_blank" style="color: #00ff9d;">Open Xaman to sign</a>.`;

    } catch (error) {
        connStatus.style.color = '#ff5722';
        connStatus.textContent = "Critical Error: Failed to send Xaman request. Check console.";
        console.error("Critical Error:", error);
    }
}


// --- 4. AUXILIARY FUNCTIONS (LP Calculator) ---
const v = document.getElementById('volume');
const f = document.getElementById('fee');
const s = document.getElementById('share');
const r = document.getElementById('result');

function calc() {
    const vol = parseFloat(v.value) || 0;
    const feeRate = (parseFloat(f.value) || 0) / 100;
    const share = (parseFloat(s.value) || 0) / 100;

    const daily = vol * feeRate * share;
    const yearly = daily * 365;

    r.innerHTML = `
      <span style="color:#0f0">Daily &asymp; $${daily.toFixed(2)}</span><br>
      <span style="color:#0cf">Yearly &asymp; $${yearly.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</span>
    `;
}

v.addEventListener('input', calc);
f.addEventListener('input', calc);
s.addEventListener('input', calc);
calc();
updateXRPToUSDC(); 
updateUSDCToXRP();
</script>

</body>
</html>
